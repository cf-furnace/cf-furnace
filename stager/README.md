# Staging apps on Docker instead of Diego

## Overview

This experiment attempts to stage and run CF applications on Docker. It piggy-backs on the existing Diego cc-bridge while the version targetting k8s is still under development.

To stage and run an app on Docker, it first has to be pushed to CF using the regular `cf` client. The staging and launch commands will be written to the corresponding log files. The `restage` command will parse the Diego staging command and implement the same functionality inside a Docker container:

* Download dependencies (lifecycle apps, buildpacks)

* Download application package

* Run the builder lifecycle command provided by the stager.

* Upload the generated droplet via cc-uploader back to the blobstore.

In addition this experimental stager also does:

* Build a docker image with the droplet and the launcher

* _Optionally_ push the new docker image to a registry (under construction)

The `launch` command will parse the Diego launch request and then start the docker image generated by the `restage` command with the information from the request (start command, environment variables, etc).

## Dependencies on HCF

The commands stored in this repo currently assume that they will be run inside an HCF Vagrant box.  They make use of the following HCF characteristics:

* Access logs under `~/.run/logs/...`

* Use docker networking to resolve CF URLs (`docker run --net hcf ...`)

* Use Docker daemon running on host to build new docker images.

* _Optionally_ use docker registry running on HCF host.

#### Patches to cc-bridge code ####

This small change to the `stager` adds the build requests to the log file:

```diff
--- a/backend/buildpack_backend.go
+++ b/backend/buildpack_backend.go
@@ -214,7 +214,7 @@ func (backend *traditionalBackend) BuildRecipe(stagingGuid string, request cc_me
                TrustedSystemCertificatesPath: TrustedSystemCertificatesPath,
        }

-       logger.Debug("staging-task-request")
+       logger.Info("staging-task-request", lager.Data{"taskDefinition": taskDefinition})

        return taskDefinition, stagingGuid, backend.config.TaskDomain, nil
 }
```

The corresponding change to `nsync` records the launch request as well:

```diff
--- a/recipebuilder/buildpack_recipe_builder.go
+++ b/recipebuilder/buildpack_recipe_builder.go
@@ -234,7 +234,7 @@ func (b *BuildpackRecipeBuilder) Build(desiredApp *cc_messages.DesireAppRequestF
        setupAction := models.Serial(setup...)
        actionAction := models.Codependent(actions...)

-       return &models.DesiredLRP{
+       desiredLRP := &models.DesiredLRP{
                Privileged: true,

                Domain: cc_messages.AppLRPDomain,
@@ -272,7 +272,9 @@ func (b *BuildpackRecipeBuilder) Build(desiredApp *cc_messages.DesireAppRequestF

                TrustedSystemCertificatesPath: TrustedSystemCertificatesPath,
                VolumeMounts:                  desiredApp.VolumeMounts,
-       }, nil
+       }
+       buildLogger.Info("desired-app-request", lager.Data{"desiredLRP": desiredLRP})
+       return desiredLRP, nil
 }

 func (b BuildpackRecipeBuilder) ExtractExposedPorts(desiredApp *cc_messages.DesireAppRequestFromCC) ([]uint32, error) {
```

## Extracting request details from the logs

Once an app has been pushed with the `cf` client, the build and launch requests can be  extracted from the logs:

```bash
$ build_req() { grep taskDef ~/.run/log/diego-cc-bridge/stager/stager.stdout.log | tail -1 | jq .data.taskDefinition; }

$ build_req | jq .cached_dependencies[0,1]
{
  "name": "",
  "from": "http://diego-access:8080/v1/static/buildpack_app_lifecycle/buildpack_app_lifecycle.tgz",
  "to": "/tmp/lifecycle",
  "cache_key": "buildpack-cflinuxfs2-lifecycle",
  "log_source": ""
}
{
  "name": "staticfile_buildpack",
  "from": "https://blobstore/read/cc-buildpacks/d4/e0/d4e03ab3-6549-48c3-a3a4-c68701bffb0d_8b683c2237056089dea24a2a4d70606e8a4a67cf?md5=fwE6so-mWXzANSrRtOYjjQ&expires=1466017043",
  "to": "/tmp/buildpacks/d1fabc710d712fd915d6bb05f9fce823",
  "cache_key": "d4e03ab3-6549-48c3-a3a4-c68701bffb0d_8b683c2237056089dea24a2a4d70606e8a4a67cf",
  "log_source": ""
}

$ build_cmd() { build_req | jq .action.timeout.action.serial.actions[1].emit_progress.action.run; }

$ build_cmd | jq .path
"/tmp/lifecycle/builder"

$ build_cmd | jq .args
[
  "-buildArtifactsCacheDir=/tmp/cache",
  "-buildDir=/tmp/app",
  "-buildpackOrder=d4e03ab3-6549-48c3-a3a4-c68701bffb0d_8b683c2237056089dea24a2a4d70606e8a4a67cf,b58b8d5a-6d21-4a22-bee5-b7f019e898dc_483c35cf7cc87e2ebb05b2b49ebd1f3223105ec8,6fff38d9-a628-4d52-900b-cc93781f91e7_f5446238d598246474e97f7aea1e8389b26b6a58,5a9cc386-920a-456a-80b4-cac823d2d8b7_ddfaa3b5c17aba2d9303306fb1fbae9aa2574b74,ad78bdda-a768-4bf4-9128-805f9eb8c7af_5dc19602391fb2571b217d754dd7652e6c76630f,def7d3f2-a043-433b-b95a-5f533bb5ad2e_ca60152b78be3f93067cd4f03d01e2db810ac2a8,03b53c4c-f201-4c5d-a1bc-4b2abe4560b1_de0d8945a76c3b1206e16509e8a03e50437a5a68,5a3b5d11-e603-44d7-9375-3d4f283f46f9_a32d9ae40371d557c7c90eb2affc3d7bba6abe69,6fe59df7-3ffc-4135-8ec5-92a6b25fed8c_9915aef123b0452d8f586152cbc7594564a09888",
  "-buildpacksDir=/tmp/buildpacks",
  "-outputBuildArtifactsCache=/tmp/output-cache",
  "-outputDroplet=/tmp/droplet",
  "-outputMetadata=/tmp/result.json",
  "-skipCertVerify=true",
  "-skipDetect=false"
]

$ launch_req() { grep desiredL ~/.run/log/diego-cc-bridge/nsync/nsync_listener.stdout.log | tail -1 | jq .data.desiredLRP; }
$ launch_cmd() { launch_req | jq .action.codependent.actions[0].run; }

$ launch_cmd | jq .path
"/tmp/lifecycle/launcher"

$ launch_cmd | jq .args
[
  "app",
  "node server.js",
  ""
]

$ launch_cmd | jq .env[6]
{
  "name": "VCAP_APPLICATION",
  "value": "{\"limits\":{\"fds\":16384,\"mem\":32,\"disk\":1024},\"application_name\":\"node-env\",\"application_uris\":[\"node-env.192.168.77.77.nip.io\"],\"name\":\"node-env\",\"space_name\":\"myspace\",\"space_id\":\"20988f15-a441-4214-bb5f-19d9bb30fef2\",\"uris\":[\"node-env.192.168.77.77.nip.io\"],\"version\":\"dc6b7ca8-736b-4405-b430-3cf306913ce3\",\"application_version\":\"dc6b7ca8-736b-4405-b430-3cf306913ce3\",\"application_id\":\"8b2a7017-fb3c-442d-9242-ac92ebdeb3ca\"}"
}

$ launch_cmd | jq '.env[6].value | fromjson'
{
  "limits": {
    "fds": 16384,
    "mem": 32,
    "disk": 1024
  },
  "application_name": "node-env",
  "application_uris": [
    "node-env.192.168.77.77.nip.io"
  ],
  "name": "node-env",
  "space_name": "myspace",
  "space_id": "20988f15-a441-4214-bb5f-19d9bb30fef2",
  "uris": [
    "node-env.192.168.77.77.nip.io"
  ],
  "version": "dc6b7ca8-736b-4405-b430-3cf306913ce3",
  "application_version": "dc6b7ca8-736b-4405-b430-3cf306913ce3",
  "application_id": "8b2a7017-fb3c-442d-9242-ac92ebdeb3ca"
}
```

## Restaging the app inside a docker container

The restage command will extract the latest staging request from the log and execute it again. It has to run inside the CF network to be able to connect to the upload and download URLs.

```
build_req | docker run -i --rm --user vcap --net hcf -v /var/run/docker.sock:/var/run/docker.sock stager
```

We also bind the socket of the docker daemon of the host to allow the stager to build new docker images. On k8s we would run another "Docker-in-Docker" container on the side to avoid having to run the stager in privileged mode.


```bash
$ ./cache-up
======> Downloading /tmp/lifecycle from http://diego-access:8080/v1/static/buildpack_app_lifecycle/buildpack_app_lifecycle.tgz
======> Downloading /tmp/buildpacks/d1fabc710d712fd915d6bb05f9fce823 from https://blobstore/read/cc-buildpacks/d4/e0/d4e03ab3-6549-48c3-a3a4-c68701bffb0d_8b683c2237056089dea24a2a4d70606e8a4a67cf?md5=fwE6so-mWXzANSrRtOYjjQ&expires=1466017043
======> Downloading /tmp/buildpacks/cbf2c5f82188ffff5ba6b73ec56e5490 from https://blobstore/read/cc-buildpacks/b5/8b/b58b8d5a-6d21-4a22-bee5-b7f019e898dc_483c35cf7cc87e2ebb05b2b49ebd1f3223105ec8?md5=qkIbg3VAWsa4AJ7x8QoFQA&expires=1466017044
======> Downloading /tmp/buildpacks/cf91fd5cedc5190b507b3fb98c998cd6 from https://blobstore/read/cc-buildpacks/6f/ff/6fff38d9-a628-4d52-900b-cc93781f91e7_f5446238d598246474e97f7aea1e8389b26b6a58?md5=2NalAn3VvGm7oZZ9K4ZdsA&expires=1466017044
======> Downloading /tmp/buildpacks/e7b01faeed7c09e13244b96bac256232 from https://blobstore/read/cc-buildpacks/5a/9c/5a9cc386-920a-456a-80b4-cac823d2d8b7_ddfaa3b5c17aba2d9303306fb1fbae9aa2574b74?md5=-sai6-9hoq84kHAKr_5stg&expires=1466017044
======> Downloading /tmp/buildpacks/3c62ce6e30d929925788e068604dfc94 from https://blobstore/read/cc-buildpacks/ad/78/ad78bdda-a768-4bf4-9128-805f9eb8c7af_5dc19602391fb2571b217d754dd7652e6c76630f?md5=yrNMFwZfWCAFUSiXXY9KXQ&expires=1466017044
======> Downloading /tmp/buildpacks/b8e84b720bf059d7f2b33bf24f03bcad from https://blobstore/read/cc-buildpacks/de/f7/def7d3f2-a043-433b-b95a-5f533bb5ad2e_ca60152b78be3f93067cd4f03d01e2db810ac2a8?md5=njnFaMu0O1WNpwSbSOjuGA&expires=1466017044
======> Downloading /tmp/buildpacks/9fc05de1c5345bebbe8a55256dbd7f6c from https://blobstore/read/cc-buildpacks/03/b5/03b53c4c-f201-4c5d-a1bc-4b2abe4560b1_de0d8945a76c3b1206e16509e8a03e50437a5a68?md5=qqzmG2cax_MTFbaMMQz3Dw&expires=1466017044
======> Downloading /tmp/buildpacks/ae2e85ba1ef709981513c1dc89c7a5a0 from https://blobstore/read/cc-buildpacks/5a/3b/5a3b5d11-e603-44d7-9375-3d4f283f46f9_a32d9ae40371d557c7c90eb2affc3d7bba6abe69?md5=CMAr6c02jzDTSP2qS4qnFw&expires=1466017044
======> Downloading /tmp/buildpacks/433f3a0041ef5de945529ac906333811 from https://blobstore/read/cc-buildpacks/6f/e5/6fe59df7-3ffc-4135-8ec5-92a6b25fed8c_9915aef123b0452d8f586152cbc7594564a09888?md5=p2crE34CkJ_ZR1vXR62Qrw&expires=1466017044
warning:  /tmp/temp20160615-1-q7fu9m appears to use backslashes as path separators
```
